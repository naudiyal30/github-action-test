name: Build and Deploy to Google Compute Engine

on:
  push:
    branches:
    - 'main'

env:
  PROJECT_ID: test-gcp-services-346407
  GCE_INSTANCE: payment-service
  GCE_INSTANCE_ZONE: us-west1-a
  KEY: AAAAB3NzaC1yc2EAAAADAQABAAABAQDA680Krdx8oIgIoJRVnQhCuKShhS9F4E/Zm2j1V4Bvro0MDn/8VfDvgh75uvDL3toggspAAozDmjNX0OeBbdf6MG4D1Wuu9g8/X7WrmGAyPKa1PSiBFPRJNkOM0ibedFSxvjpj7/aRXOSO7hFAhG8rDC8mVVZYo/aTPxj6z6LUoHsSp1HOGxxQsf3mir6TMITCrxRspAdMLJ9c5pFQQg+4YTRRNDg76rMjRth/wtz26GpWx0jnxFWwvszjnIGbjPTdXrl54fB8UNWnRc7oqmIzmb6P6pmDPwEtfoAyBAXtsEOU/0FyoJagnth1O+ZwZjAOk/7+lK4Rwhq7jdoC1a0b


jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest

    # Add "id-token" with the intended permissions.
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    # Configure Workload Identity Federation and generate an access token.
   # - id: 'auth'
   #   name: 'Authenticate to Google Cloud'
    #  uses: 'google-github-actions/auth@v0'
    #  with:
    #    workload_identity_provider: 'projects/123456789/locations/global/workloadIdentityPools/my-pool/providers/my-provider'
    #    service_account: 'my-service-account@my-project.iam.gserviceaccount.com'

    # Alternative option - authentication via credentials json
    - id: 'auth'
      uses: 'google-github-actions/auth@v0'
      with:
         credentials_json: ${{ secrets.SA_KEY }}

    # Setup gcloud CLI
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v0

    - name: Permission granted
      run: chmod 777 key.pub
    
    - name: Install sshpass
      run: sudo apt-get install sshpass
    
    - name: SSH in compute vm
      run: sshpass -p ${{ secrets.PUBLIC_KEY }} ssh jatinnaudiyal2305@35.197.48.187
    
    - name: Startup script
      run: ./home/jatinnaudiyal2305/startup.sh
     
