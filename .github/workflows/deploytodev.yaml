name: Build and Deploy - DEV

on:
  push:
    branches:
      - testt

  workflow_dispatch:

# Environment variables available to all jobs and steps in workflow
env:
  SERVICE_NAME: ${{ github.event.repository.name }}
  PROJECT_ID: test-gcp-services-346407
  COMMIT_SHA: ${{ github.sha }}

jobs:
  setup-build-dev:
    name: Setup, Build, and Deploy
    runs-on: ubuntu-latest
    steps:
      # Get the code
      - name: Checkout
        uses: actions/checkout@v2
  
      - name: Deploy app
        uses: victorargento/pm2-deployment@main
        with:
          host: ${{ secrets.HOST }}
          port: 3004
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          script: |
            cd /backend-project-folder
            sudo git stash
            sudo GIT_SSH_COMMAND="ssh -i ~/.ssh/authorized_keys" git pull origin dev
            export NVM_DIR=~/.nvm
            source ~/.nvm/nvm.sh
            npm install
            pm2 restart 0
